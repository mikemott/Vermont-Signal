#cloud-config

# Vermont Signal V2 - Hetzner Cloud Setup
# This script runs on first boot and sets up Docker, security, and project directories

package_update: true
package_upgrade: true

packages:
  - apt-transport-https
  - ca-certificates
  - curl
  - gnupg
  - lsb-release
  - git
  - ufw
  - fail2ban
  - unattended-upgrades

runcmd:
  # Install Docker
  - curl -fsSL https://get.docker.com -o /tmp/get-docker.sh
  - sh /tmp/get-docker.sh
  - systemctl enable docker
  - systemctl start docker

  # Install Docker Compose v2
  - mkdir -p /usr/local/lib/docker/cli-plugins
  - curl -SL https://github.com/docker/compose/releases/download/v2.24.0/docker-compose-linux-x86_64 -o /usr/local/lib/docker/cli-plugins/docker-compose
  - chmod +x /usr/local/lib/docker/cli-plugins/docker-compose

  # Configure UFW firewall (redundant with Hetzner firewall, but good practice)
  - ufw allow OpenSSH
  - ufw allow 80/tcp
  - ufw allow 443/tcp
  - ufw allow 8000/tcp
  - ufw --force enable

  # Configure fail2ban for SSH protection
  - systemctl enable fail2ban
  - systemctl start fail2ban

  # Enable automatic security updates
  - echo 'APT::Periodic::Update-Package-Lists "1";' > /etc/apt/apt.conf.d/20auto-upgrades
  - echo 'APT::Periodic::Unattended-Upgrade "1";' >> /etc/apt/apt.conf.d/20auto-upgrades

  # Create project directory
  - mkdir -p /opt/vermont-signal
  - mkdir -p /opt/vermont-signal/data/postgres
  - mkdir -p /opt/vermont-signal/data/ml-models

  # Set up Docker log rotation
  - |
    cat > /etc/docker/daemon.json <<EOF
    {
      "log-driver": "json-file",
      "log-opts": {
        "max-size": "10m",
        "max-file": "3"
      }
    }
    EOF
  - systemctl restart docker

  # Create a deployment flag file
  - touch /opt/vermont-signal/server-ready
  - echo "Server setup complete at $(date)" >> /opt/vermont-signal/setup.log

write_files:
  - path: /etc/fail2ban/jail.local
    content: |
      [DEFAULT]
      bantime = 3600
      findtime = 600
      maxretry = 5

      [sshd]
      enabled = true
      port = ssh
      logpath = %(sshd_log)s
      backend = %(sshd_backend)s

  - path: /root/.bashrc_custom
    content: |
      # Vermont Signal Shortcuts
      alias dc='docker compose'
      alias dps='docker ps'
      alias dlogs='docker compose logs -f'
      alias vs='cd /opt/vermont-signal'

      echo "ğŸš€ Vermont Signal V2 Server"
      echo "ğŸ“ Project: /opt/vermont-signal"
      echo "ğŸ“Š Status: docker compose ps"
      echo "ğŸ“œ Logs: docker compose logs -f"
    append: true

timezone: America/New_York

final_message: |
  Vermont Signal V2 server is ready!

  Docker installed: $(docker --version)
  Docker Compose installed: $(docker compose version)

  Next steps:
  1. Clone your repository to /opt/vermont-signal
  2. Copy .env file with API keys
  3. Run: docker compose up -d

  Server uptime: $UPTIME
